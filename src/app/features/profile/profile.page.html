<!-- src/app/features/profile/profile.page.html -->
<div class="profile-page">

    <div class="page-header">
        <div class="title">
            <h1>Th√¥ng tin c√° nh√¢n</h1>
            <p>C·∫≠p nh·∫≠t th√¥ng tin ƒë·ªÉ kh√°ch h√†ng d·ªÖ li√™n h·ªá & t√¨m ƒë·∫øn b·∫°n</p>
        </div>
    </div>

    <!-- Avatar -->
    <div class="card avatar-card">
        <div class="avatar-box">
            <div class="avatar">
                <img *ngIf="avatarPreview()" [src]="avatarPreview()!" alt="avatar" />
                <div class="fallback" *ngIf="!avatarPreview()">{{ initials() }}</div>
            </div>

            <div class="avatar-meta">
                <div class="name">{{ form.value.fullName || 'Ch∆∞a c√≥ t√™n' }}</div>
                <div class="hint">·∫¢nh ƒë·∫°i di·ªán hi·ªÉn th·ªã v·ªõi kh√°ch h√†ng</div>

                <label class="btn ghost">
                    <input type="file" accept="image/*" hidden (change)="onAvatarFileChange($event)" />
                    üì∑ Ch·ªçn ·∫£nh
                </label>
            </div>
        </div>
    </div>

    <!-- Form -->
    <form class="card form-card" [formGroup]="form" (ngSubmit)="save()">
        <div class="grid">
            <div class="field">
                <label>H·ªç t√™n <span>*</span></label>
                <input formControlName="fullName" placeholder="VD: Nguy·ªÖn VƒÉn A" />
                <small *ngIf="form.get('fullName')?.touched && form.get('fullName')?.invalid">B·∫Øt bu·ªôc nh·∫≠p</small>
            </div>

            <div class="field">
                <label>S·ªë ƒëi·ªán tho·∫°i <span>*</span></label>
                <input formControlName="phone" placeholder="VD: 0987xxxxxx" />
                <small *ngIf="form.get('phone')?.touched && form.get('phone')?.invalid">B·∫Øt bu·ªôc nh·∫≠p</small>
            </div>

            <div class="field">
                <label>Email</label>
                <input formControlName="email" placeholder="VD: abc@gmail.com" />
            </div>
        </div>

        <div class="field">
            <label>M√¥ t·∫£</label>
            <textarea formControlName="description" rows="3" placeholder="Gi·ªõi thi·ªáu ng·∫Øn ƒë·ªÉ kh√°ch h√†ng tin t∆∞·ªüng..."></textarea>
        </div>

        <!-- Addresses -->
        <div class="addresses" formArrayName="addresses">
            <div class="section-title">
                <h3>ƒê·ªãa ch·ªâ</h3>
                <button type="button" class="btn ghost" (click)="addAddress()">+ Th√™m ƒë·ªãa ch·ªâ</button>
            </div>

            <div
                    class="address-card"
                    *ngFor="let a of addresses().controls; let i = index"
                    [formGroupName]="i"
            >
                <div class="row-head">
                    <div class="field">
                        <label>Ti√™u ƒë·ªÅ <span>*</span></label>
                        <input formControlName="label" placeholder="VD: C·ª≠a h√†ng, Chi nh√°nh 2..." />
                    </div>

                    <div class="actions">
                        <button type="button" class="btn tiny" (click)="toggleMap(i)">
                            üó∫ {{ openedMapIndex() === i ? '·∫®n b·∫£n ƒë·ªì' : 'B·∫£n ƒë·ªì' }}
                        </button>

                        <button
                                type="button"
                                class="btn tiny"
                                [disabled]="gettingLocation() === i"
                                (click)="useCurrentLocation(i)"
                        >
                            üìç {{ gettingLocation() === i ? 'ƒêang l·∫•y...' : 'V·ªã tr√≠ hi·ªán t·∫°i' }}
                        </button>

                        <button type="button" class="btn tiny danger" *ngIf="addresses().length > 1" (click)="removeAddress(i)">
                            ‚úï
                        </button>
                    </div>
                </div>

                <div class="field">
                    <label>ƒê·ªãa ch·ªâ <span>*</span></label>
                    <input
                            formControlName="address"
                            placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒë·ªÉ g·ª£i √Ω..."
                            (input)="onAddressTyping(i)"
                            autocomplete="off"
                    />

                    <!-- Suggestion -->
                    <div class="suggestions" *ngIf="suggestions()[i]?.length">
                        <div
                                class="suggest-item"
                                *ngFor="let s of suggestions()[i]"
                                (click)="selectSuggestion(i, s)"
                        >
                            {{ s.display_name }}
                        </div>
                    </div>

                    <small *ngIf="a.get('address')?.touched && a.get('address')?.invalid">B·∫Øt bu·ªôc nh·∫≠p</small>
                </div>

                <!-- Map -->
                <div class="map-wrap" *ngIf="openedMapIndex() === i">
                    <div class="map" [id]="'map-' + i"></div>
                    <div class="map-hint">
                        ‚úÖ Click b·∫£n ƒë·ªì ƒë·ªÉ ƒë·∫∑t ghim ‚Ä¢ ‚úÖ K√©o ghim ƒë·ªÉ ch·ªânh ƒë√∫ng v·ªã tr√≠
                    </div>
                </div>
            </div>
        </div>

        <!-- footer -->
        <div class="form-footer">
            <button type="button" class="btn ghost" (click)="reset()">Ho√†n t√°c</button>
            <button type="submit" class="btn primary" [disabled]="saving()">
                {{ saving() ? 'ƒêang l∆∞u...' : 'L∆∞u thay ƒë·ªïi' }}
            </button>
        </div>

        <div class="msg" *ngIf="message()">{{ message() }}</div>
    </form>
</div>
